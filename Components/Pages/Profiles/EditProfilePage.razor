@using BookHeaven.Domain.Features.Profiles
@attribute [Route($"{Urls.Profiles}/{{Id:guid}}")]
@attribute [Route(Urls.CreateProfile)]
@layout SimpleLayout

@if (_profile is null)
{
	return;
}

@if (_profile.ProfileId != Guid.Empty)
{
	<SectionContent SectionName="Tools">
		<MudButton
			StartIcon="@Icons.Material.Filled.Delete"
			OnClick="Delete"
			Variant="Variant.Outlined"
			Color="Color.Error">
			@Domain.Localization.Translations.DELETE
		</MudButton>
	</SectionContent>
}

<div class="w-[400px] mx-auto">
	<h1 class="text-center text-2xl md:text-4xl animate-fade-in mt-10">
		@if (_profile.ProfileId == Guid.Empty)
		{
			@Translations.PROFILE_CREATE
		}
		else
		{
			@Translations.PROFILE_EDIT
		}
	</h1>
	<MudTextField 
		Required="true"
		Class="mt-20 2xl:mt-30"
		Label="@Translations.NAME" 
		@bind-Value="_profile.Name"
		Variant="Variant.Outlined"/>
	<MudButton
		OnClick="Save"
		Class="mt-10"
		Variant="Variant.Filled"
		Color="Color.Primary"
		FullWidth="true">
		@Translations.SAVE
	</MudButton>
</div>


@code {
	[Inject] private ISender Sender { get; set; } = null!;
	[Inject] private NavigationManager NavigationManager { get; set; } = null!;
	[Inject] private IDialogService DialogService { get; set; } = null!;
	[Inject] private ISessionService SessionService { get; set; } = null!;
	
	[Parameter] public Guid? Id { get; set; }

	private Profile? _profile = new();

	protected override async Task OnInitializedAsync()
	{
		if (Id is not null)
		{
			var getProfile = await Sender.Send(new GetProfileById.Query(Id.Value));
			if (getProfile.IsSuccess)
			{
				_profile = getProfile.Value;
			}
			else
			{
				// Handle error, e.g., redirect or show a message
				Console.WriteLine(getProfile.Error);
			}
		}
	}

	private async Task Save()
	{
		if(string.IsNullOrEmpty(_profile!.Name)) return;
		var skipProfilesPage = false;
		
		
		if (_profile!.ProfileId == Guid.Empty)
		{
			var createProfile = await Sender.Send(new CreateProfile.Command(_profile.Name));
			if (createProfile.Value.TotalProfiles == 1)
			{
				await SessionService.SetAsync(SessionKey.SelectedProfileId, createProfile.Value.ProfileId);
				skipProfilesPage = true;
			}
		}
		else
		{
			var updateProfile = await Sender.Send(new UpdateProfileName.Command(_profile.ProfileId, _profile.Name));
		}

		NavigationManager.NavigateTo(skipProfilesPage ? Urls.Shelf : Urls.Profiles);
	}
	
	private async Task Delete()
	{

		var result = await DialogService.ShowMessageBox(
			Domain.Localization.Translations.WARNING,
			Translations.PROFILE_DELETE_WARNING_MESSAGE,
			yesText: Domain.Localization.Translations.YES,
			cancelText: Domain.Localization.Translations.NO);
		
		if (result is not true) return;

		var deleteProfile = await Sender.Send(new DeleteProfile.Command(_profile!.ProfileId));
		if (deleteProfile.IsSuccess)
		{
			NavigationManager.NavigateTo(Urls.Profiles);
		}
		else
		{
			Console.WriteLine(deleteProfile.Error);
			// Handle error, e.g., show a message to the user
		}
	}

}